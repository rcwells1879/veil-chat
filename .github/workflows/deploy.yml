name: ğŸš€ Deploy VeilChat to Production

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    name: ğŸ‰ Deploy to Namecheap FTP
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ§¹ Prepare deployment files
        run: |
          # Create deployment directory
          mkdir -p deploy
          
          # Copy contents of src/ directly to deploy/ (not the src folder itself)
          cp -r src/* deploy/
          
          # Remove server-side files from deployment
          rm -rf deploy/server/ 2>/dev/null || echo "No server directory to remove"
          
          # Copy root level files if they exist
          cp index.html deploy/ 2>/dev/null || echo "No root index.html found"
          cp manifest.json deploy/ 2>/dev/null || echo "No manifest.json found"
          
          # Update service worker with build timestamp for automatic cache versioning
          BUILD_TIME=$(date +%s)
          sed -i "s/const CACHE_VERSION = Date\.now();/const CACHE_VERSION = '${BUILD_TIME}';/" deploy/service-worker.js
          echo "âœ… Updated service worker cache version to: ${BUILD_TIME}"
          
          # List what will be deployed
          echo "ğŸ“ Files prepared for deployment:"
          find deploy -type f | head -20
          
          # Debug: Show specific files we expect
          echo "ğŸ” Checking for key files:"
          ls -la deploy/index.html 2>/dev/null && echo "âœ… index.html found" || echo "âŒ index.html missing"
          ls -la deploy/css/desktop-styles.css 2>/dev/null && echo "âœ… desktop-styles.css found" || echo "âŒ desktop-styles.css missing"  
          ls -la deploy/js/desktopInterface.js 2>/dev/null && echo "âœ… desktopInterface.js found" || echo "âŒ desktopInterface.js missing"

      - name: ğŸ“‚ Deploy to FTP server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ./public_html/veilchat/
          dry-run: false
          log-level: verbose
          exclude: |
            **/node_modules/**
            **/server/**
            **/.git/**
            **/.github/**
            **/test/**
            **/tests/**
            **/*.test.js
            **/*.spec.js
            **/package*.json
            **/CLAUDE*.md
            **/claude-startup.sh
            **/lmstudio-proxy.js
            **/.env*
            **/.*
          dry-run: false
          log-level: verbose

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ VeilChat has been successfully deployed!"
          echo "ğŸŒ Your application is available at: https://veilstudio.io/veilchat"
          echo "ğŸ“ Remember to hard refresh (Ctrl+Shift+R) to see changes"