name: 🚀 Deploy VeilChat to Production

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    name: 🎉 Deploy to Namecheap FTP
    runs-on: ubuntu-latest
    
    steps:
      - name: 🚚 Get latest code
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🏗️ Build application
        run: npm run build

      - name: 🧹 Prepare deployment files
        run: |
          # Create deployment directory
          mkdir -p deploy
          
          # Copy only the web application files (no server files)
          cp -r src/ deploy/
          cp index.html deploy/ 2>/dev/null || echo "No root index.html found"
          cp manifest.json deploy/ 2>/dev/null || echo "No manifest.json found"
          cp *.md deploy/ 2>/dev/null || echo "No markdown files found"
          
          # Copy specific files if they exist at root level
          if [ -f "src/index.html" ]; then
            cp src/index.html deploy/index.html
          fi
          
          # Remove server-side files from deployment
          rm -rf deploy/src/server/ 2>/dev/null || echo "No server directory to remove"
          
          # List what will be deployed
          echo "📁 Files prepared for deployment:"
          find deploy -type f | head -20

      - name: 📂 Deploy to FTP server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ./veilchat/
          exclude: |
            **/node_modules/**
            **/server/**
            **/.git/**
            **/.github/**
            **/test/**
            **/tests/**
            **/*.test.js
            **/*.spec.js
            **/package*.json
            **/CLAUDE*.md
            **/claude-startup.sh
            **/lmstudio-proxy.js
            **/.env*
            **/.*
          dry-run: false
          log-level: verbose

      - name: ✅ Deployment complete
        run: |
          echo "🎉 VeilChat has been successfully deployed!"
          echo "🌐 Your application is available at: https://veilstudio.io/veilchat"
          echo "📝 Remember to hard refresh (Ctrl+Shift+R) to see changes"